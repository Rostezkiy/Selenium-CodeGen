# План алгоритмических улучшений Autotest Generator

## Цели
1. Улучшить точность и устойчивость локаторов для динамических веб-приложений (Angular, React, Vue).
2. Расширить покрытие типов элементов и действий для универсальности инструмента.
3. Повысить надежность генерации кода без зависимостей от ИИ.

## Приоритетные задачи (в порядке важности)

### 1. Улучшение алгоритма генерации селекторов
**Проблема:** Текущий алгоритм выбирает селекторы на основе приоритета: data-testid, id, name, placeholder, текст, тег. Однако для динамических приложений id и классы часто меняются, что приводит к хрупким локаторам.

**Предлагаемые улучшения:**
- Реализовать алгоритм "устойчивого селектора" на основе комбинации атрибутов:
  - Приоритет: `data-*` атрибуты (настраиваемые пользователем), `aria-*`, `role`, `name`, `placeholder`, `title`, `alt`.
  - Генерация CSS-селектора по комбинации нескольких атрибутов (например, `[data-testid="login"][role="button"]`).
  - Использование относительных XPath с учетом структуры DOM, но без зависимостей от динамических классов.
- Добавить стратегию "умного падения": если найденный селектор неуникален, добавлять родительский контекст.
- Интеграция с популярными библиотеками компонентов: заранее известные селекторы для Angular Material, React Bootstrap и т.д. (опционально).

**Затрагиваемые файлы:**
- `client/content_script.js` – функция `generateSelectors`
- `client/background.js` – функция `generateLocatorList`
- `client/options.js` – настройки стратегий

### 2. Поддержка shadow DOM
**Проблема:** Элементы внутри shadow root не обнаруживаются стандартными методами записи.

**Решение:**
- Расширить функцию `getElementInfo` для обхода shadow DOM с помощью `element.shadowRoot`.
- Рекурсивный поиск внутри каждого shadow root.
- Генерация селекторов с учетом shadow-границы (например, использование `>>>` /deep/ комбинатора или JavaScript-доступ).
- В генерации кода использовать `driver.execute_script` для доступа к shadow элементам или использовать поддержку shadow DOM в Selenium 4 (`.shadowRoot`).

**Затрагиваемые файлы:**
- `client/content_script.js` – модификация `getElementInfo`, `findElementBySelectors`
- `app/code_generator.py` – добавление методов работы с shadow DOM в BasePage

### 3. Расширенная стратегия healing locators
**Проблема:** Healing locators сейчас просто перебирают список селекторов. Нужно добавить более умное восстановление при изменениях DOM.

**Улучшения:**
- Реализовать алгоритм "похожести" элементов: если оригинальный селектор не работает, искать элемент с похожими атрибутами (например, текст, роль, тип).
- Кэширование найденных элементов для повторного использования.
- Добавить возможность пользовательской настройки весов атрибутов для healing.

**Затрагиваемые файлы:**
- `app/code_generator.py` – класс BasePage, метод `find_element_with_healing`
- `client/background.js` – функция `generateLocatorList` (добавить альтернативные селекторы)

### 4. Улучшенная работа с iframe
**Проблема:** Запись переключения между iframe реализована, но может быть ненадежной при динамическом добавлении iframe.

**Улучшения:**
- Автоматическое определение контекста iframe при записи (сохранение xpath iframe).
- Генерация кода с использованием `WebDriverWait` для ожидания доступности iframe.
- Поддержка вложенных iframe.

**Затрагиваемые файлы:**
- `client/content_script.js` – сбор информации об iframe
- `client/background.js` – обработка шагов `switch_to_iframe`
- `app/code_generator.py` – методы `switch_to_iframe` и `switch_to_default_content`

### 5. Интеграция с библиотеками компонентов
**Проблема:** Для Angular Material, React Table и других библиотек элементы имеют сложную структуру, и стандартные селекторы могут быть неэффективны.

**Решение:**
- Создать словарь известных компонентов с шаблонами селекторов (например, для mat-button использовать атрибут `mat-button`).
- Добавить настройку в options для включения/выключения интеграции.
- При обнаружении соответствующего атрибута генерировать рекомендованный селектор.

**Затрагиваемые файлы:**
- `client/background.js` – расширение `generateLocatorList`
- `client/options.html` – добавление чекбоксов

### 6. Расширение функциональности записи действий
**Проблема:** Отсутствие поддержки drag-and-drop, скролла, клавиатурных действий, работы с алертами.

**Предлагаемые действия:**
- **Drag-and-drop:** Запись событий `dragstart`, `dragover`, `drop` с определением исходного и целевого элемента.
- **Скролл:** Запись прокрутки колесиком мыши или скроллбара (сложно, но можно записать действие скролла до элемента).
- **Клавиатурные действия:** Запись нажатий клавиш (например, Enter, Tab) с привязкой к активному элементу.
- **Алерты/модальные окна:** Запись действий `alert`, `confirm`, `prompt` с генерацией соответствующих обработчиков в коде.

**Затрагиваемые файлы:**
- `client/content_script.js` – добавление обработчиков событий
- `client/background.js` – добавление типов шагов
- `app/code_generator.py` – добавление методов в BasePage

## Дорожная карта реализации (поэтапно)

### Этап 1: Улучшение генерации селекторов (2-3 дня)
1. Анализ текущего алгоритма в `generateSelectors` и `generateLocatorList`.
2. Разработка нового алгоритма с приоритетом устойчивых атрибутов.
3. Тестирование на различных веб-приложениях.
4. Рефакторинг и интеграция.

### Этап 2: Поддержка shadow DOM (2-3 дня)
1. Исследование возможностей доступа к shadow DOM через content script.
2. Модификация `getElementInfo` для рекурсивного обхода.
3. Обновление генерации кода для поддержки shadow элементов.
4. Тестирование на примерах с shadow DOM.

### Этап 3: Расширенная healing стратегия (1-2 дня)
1. Улучшение метода `find_element_with_healing` с алгоритмом похожести.
2. Добавление кэширования.
3. Тестирование на динамически изменяемых элементах.

### Этап 4: Улучшение работы с iframe (1 день)
1. Уточнение логики переключения контекста.
2. Генерация более надежного кода.
3. Тестирование на страницах с iframe.

### Этап 5: Интеграция с библиотеками компонентов (1-2 дня)
1. Создание словаря компонентов.
2. Интеграция в процесс генерации селекторов.
3. Тестирование на Angular Material / React Bootstrap.

### Этап 6: Расширение функциональности записи (3-4 дня)
1. Добавление обработчиков для drag-and-drop.
2. Добавление поддержки клавиатурных действий.
3. Добавление работы с алертами.
4. Обновление генерации кода для новых типов действий.

## Риски и ограничения
- Shadow DOM может быть закрыт из-за политики безопасности (закрытый shadow root). Нужно предусмотреть fallback.
- Динамические атрибуты могут меняться каждый раз, что делает невозможным создание абсолютно устойчивых селекторов. Потребуется использование относительных путей.
- Увеличение сложности алгоритмов может повлиять на производительность записи. Необходимо оптимизировать.

## Следующие шаги
После реализации алгоритмических улучшений можно рассмотреть ИИ-функции:
- Использование локальных моделей (Qwen 8b) для генерации селекторов.
- Автоматическое предложение улучшений тестов (добавление проверок, оптимизация).
- Генерация описаний шагов на естественном языке.
